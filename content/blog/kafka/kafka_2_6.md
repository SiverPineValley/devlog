---
title: '2-6) 토픽과 파티션'
date: 2024-12-07 15:10:00
category: 'kafka'
draft: false
---

- `토픽(Topic)`: 카프카에서 데이터를 구분하기 위해 사용되는 단위. 토픽은 1개 이상의 파티션을 소유한다. 파티션에는 프로듀서가 보낸 데이터가 저장되는데, 이를 `레코드(Record)`라고 한다. 
- `파티션(Partition)`: 자료구조에서 접하는 `큐(queue)`와 비슷한 구조로, 컨슈머는 FIFO 구조와 같이 먼저 들어간 데이터를 먼저 컨슘한다. 큐와 다른 점은 레코드가 컨슘되더라도 삭제하지 않는다는 점이다. 따라서 다양한 목적을 가진 컨슈머 그룹들이 토픽 데이터를 여러 번 가져가게 된다.


## 2-6-1) 토픽 생성 시 파티션이 배치되는 방법

</br>

<div align="left">
  <img src="./images/스크린샷 2024-12-07 오후 2.45.05.png" width="500px" />
</div>

</br>

- 파티션이 생성되면 위와 같이 0번 브로커부터 round-robin 방식으로 리더 브로커들이 생성된다. 카프카 클라이언트는 리더 파티션이 있는 브로커와 통신하여 복제를 진행하므로 여러 브로커에 골고루 네트워크 통신을 진행하게 된다. 이를 통해 데이터가 특정 브로커와 통신이 집중되는 현상(hot spot)을 막고 scale out을 하여 데이터가 많아지더라도 자연스럽게 대응할 수 있게 된다. 

</br>

<div align="left">
  <img src="./images/스크린샷 2024-12-07 오후 2.45.52.png" width="500px" />
</div>

</br>

- 리더 파티션이 생성되고 나면 나머지 브로커들에는 팔로워 파티션들이 생성된다. 팔로워 파티션은 리더 파티션 넘버의 +1, +2 순서로 생성되며, Replication Factor에 따라 생성되는 개수가 달라진다. 그런데 간혹 특정 브로커에 리더 파티션들이 몰려서 생성되는 경우가 있는데, 이러면 해당 브로커에만 자원 사용량이 집중된다. 이러한 현상을 해결하기 위해 파티션을 rebalance할 수 있는 기능이 있는데, `kafka-reassign-partition.sh` 쉘 스크립트 명령을 통해 해결 가능하다.

## 2-6-2) 파티션 개수와 컨슈머 개수의 처리량

</br>

<div align="left">
  <img src="./images/스크린샷 2024-12-07 오후 2.46.16.png" width="500px" />
</div>

</br>

- 파티션은 카프카의 병렬 처리의 핵심으로써 그룹으로 묶인 컨슈머들이 레코드를 병렬으로 처리할 수 있도록 매칭된다. 파티션 한개에 컨슈머 한개만 매칭될 수 있는데, 반대로 컨슈머 한개는 여러 파티션에 매칭될 수 있기 때문에 컨슈머 처리량이 한정된 상황에서 많은 레코드를 병렬로 처리하기 가장 좋은 방법은 컨슈머의 개수를 늘려 스케일 아웃하는 방법이다. 컨슈머를 늘림과 동시에 파티션 개수도 늘리면 처리량이 더욱 증가하는 모습을 볼 수 있다.
- 만약 프로듀서의 초당 데이터 발생이 10 TPS이고, 3개의 컨슈머가 존재하고 컨슈머 한개가 초당 1개의 레코드를 처리할 수 있는 상황이라면 프로듀스 되는 레코드가 훨씬 많으므로 점점 쌓이는 레코드의 수가 증가한다. 이러한 컨슈머의 데이터 처리 지연을 `컨슈머 렉(Consumer Lag)`이라고 한다.
- 보통의 운영 시에는 현재의 Produce되는 레코드 보다 조금 여유 있게 파티션과 컨슈머의 수를 조절하는 편이다.
- 다만 이렇게 파티션 수를 늘리는 것에는 주의 점이 있는데, 파티션의 개수를 줄이는 것은 불가능하다는 점이다. 파티션 수를 줄이는 방법은 토픽을 삭제하고 재생성하는 방법밖에 없다. 카프카에서는 파티션의 데이터를 세그먼트 단위로 저장하고 있기에 만에 하나 파티션을 줄이는 것을 지원하더라도 여러 브로커에 저장된 데이터를 취합하고 정렬하는 복잡한 과정을 거쳐야 하므로 클러스터에 큰 영향이 가게 된다.